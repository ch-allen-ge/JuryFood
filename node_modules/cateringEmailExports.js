var nodemailer = require('nodemailer');
var smtpTransport = require('nodemailer-smtp-transport');
var conversions = require('conversionExports.js');

var exports = module.exports = {};

exports.sendEmail = function(info, random_letters, row) {

		var mailOptions = {
			from: info.email + '@mad.ucourts.gov', // sender address
			to: qwertypoiuy@randomEmail.com
			subject: getSubject(info),//subject line
			html: getBody(info, random_letters, row) // html body
		}

		var transporter = nodemailer.createTransport(smtpTransport({
			host: 'theSecretHost'
			port: 3.14159643
		}));

	transporter.sendMail(mailOptions);
	console.log(row);
	console.log('Email Sent');
};

var getSubject = function(info) {

	var theTime;

	if (info.foodChoice === 'breakfast') {
		theTime = conversions.convertHour(info.breakfastHour) + ':' + info.breakfastMinute + ' ' + info.breakfastTimezone;
	} else if (info.foodChoice === 'deli' || info.foodChoice === 'breakfastdeli') {
		theTime = conversions.convertHour(info.lunchHour) + ':' + info.lunchMinute + ' ' + info.lunchTimezone;
	} else if (info.foodChoice === 'neither') {
		theTime = conversions.convertHour(info.customHour) + ':' + info.customMinute + ' ' + info.customTimezone;	
	}

	var subject = 'Jury Food Order: ' + info.office + ':' + info.shortYear + '-' + info.caseType + '-' + info.caseNumber + '-' + info.judge + ' ' + conversions.convertDayOfWeek(info.endDayOfWeek) + ' ' + conversions.convertMonth(info.endMonth) + ' ' + info.endDay + ', ' + info.endYear + ' at ' + theTime;

	return subject;
}

var getCustomTable = function(info) {
	if (info.otherItemsNeeded === true) {
		var allFood = '';
		for (i = 0; i < info.customFood.length; i++) { 
    		allFood += info.customFood[i].foodQuantity+' @ '+info.customFood[i].foodName+'<br>';
		}

		return allFood;
	} else {
		return '';
	}
};

var getFoodTable = function(info, random_letters, row) {
	var foodTable = "";
	var today = new Date();
	var end = new Date();
	today.setFullYear(info.beginYear, info.beginMonth , info.beginDay);
	end.setFullYear(info.endYear, info.endMonth, info.endDay);
	var stringToAdd;
	var index = 0;

	while (today <= end) {			
		if (info.foodChoice === 'breakfast') {
			stringToAdd =  '<tr>'+
							   '<td>'+row[index]+random_letters[index]+'</td>'+
							   '<td>Exchange</td>'+
							   '<td>'+conversions.convertDayOfWeek(today.getDay()) + ' ' + conversions.convertMonth(today.getMonth()) + ' ' + today.getDate() + ',' + today.getFullYear() + ' at ' + info.breakfastHour + ':' + info.breakfastMinute + ' ' + info.breakfastTimezone + '</td>'+
						    '</tr>';
			index++;
		} else if (info.foodChoice === 'deli') {
			stringToAdd =  '<tr>'+
							    '<td>'+row[index]+random_letters[index]+'</td>'+
							    '<td>Gourmet Deli</td>'+
							    '<td>'+conversions.convertDayOfWeek(today.getDay()) + ' ' + conversions.convertMonth(today.getMonth()) + ' ' + today.getDate() + ',' + today.getFullYear() + ' at ' + info.lunchHour + ':' + info.lunchMinute + ' ' + info.lunchTimezone + '</td>'+
						    '</tr>';
			index++;
		} else if (info.foodChoice === 'breakfastdeli') {
			stringToAdd =  '<tr>'+
							    '<td>'+row[index]+random_letters[index]+'</td>'+
							    '<td>Exchange</td>'+
							    '<td>'+conversions.convertDayOfWeek(today.getDay()) + ' ' + conversions.convertMonth(today.getMonth()) + ' ' + today.getDate() + ',' + today.getFullYear() + ' at ' + info.breakfastHour + ':' + info.breakfastMinute + ' ' + info.breakfastTimezone + '</td>'+
						    '</tr>';
			index++;

			stringToAdd += 	'<tr>'+
							    '<td>'+row[index]+random_letters[index]+'</td>'+
							    '<td>Gourmet Deli</td>'+
							    '<td>'+conversions.convertDayOfWeek(today.getDay()) + ' ' + conversions.convertMonth(today.getMonth()) + ' ' + today.getDate() + ',' + today.getFullYear() + ' at ' + info.lunchHour + ':' + info.lunchMinute + ' ' + info.lunchTimezone + '</td>'+
						    '</tr>';
			index++;
		} else if (info.foodChoice === 'neither') {
			stringToAdd =  '<tr>'+
							    '<td>'+row[index]+random_letters[index]+'</td>'+
							    '<td> </td>'+
							    '<td>'+conversions.convertDayOfWeek(today.getDay()) + ' ' + conversions.convertMonth(today.getMonth()) + ' ' + today.getDate() + ',' + today.getFullYear() + ' at ' + info.customHour + ':' + info.customMinute + ' ' + info.customTimezone + '</td>'+
						    '</tr>';
			index++;
		}

		foodTable += stringToAdd;
		stringToAdd = "";
		today.setDate(today.getDate()+1);
	};

	return foodTable;
};

var getBody = function(info, random_letters, row) {
	var todaysDate = new Date();
		return '<p style="font-size:150%">This is a request for jury food.</p><br>'+
					'<table style="width:80%">'+
						'<tr>'+
							'<td style="width:35%; height:35px">Case Number: </td>'+
							'<td style="height:35px">'+info.office+':'+info.shortYear+'-'+info.caseType+'-'+info.caseNumber+'-'+info.judge+'</td>'+
						'</tr>'+
						'<tr>'+
							'<td style="width:35%; height:35px">Number of Sitting Jurors: </td>'+
							'<td style="height:35px">'+info.jurors+'</td>'+
						'</tr>'+
						'<tr>'+
							'<td style="width:35%; height:35px">Requested By: </td>'+
							'<td style="height:35px">'+info.email+' at extension '+info.phone+'</td>'+
						'</tr>'+
						'<tr>'+
							'<td style="width:35%; height:35px">Number of Meals Requested: </td>'+
							'<td style="height:35px">'+info.quantity+'</td>' +
						'</tr>' +
						'<tr>'+
							'<td style="width:35%; height:35px">Additional Comments: </td>'+
							'<td style="height:35px">'+info.additionalComments+'</td>' +
						'</tr>' +
						'<tr>'+
							'<td style="width:35%; height:35px">Other Items: </td>'+
							'<td style="height:35px">'+getCustomTable(info)+'</td>' +
						'</tr>' +
						'<tr>'+
							'<td style="width:35%; height:35px">Request Date: </td>'+
							'<td style="height:35px">'+conversions.convertDayOfWeek(todaysDate.getDay())+' ' +conversions.convertMonth(todaysDate.getMonth()) + ' ' + todaysDate.getDate() + ',' + todaysDate.getFullYear() + ' ' + (((todaysDate.getHours() + 11) % 12) + 1) + ':' + conversions.convertMinute(todaysDate.getMinutes()) + ' ' + conversions.convertTimezone(todaysDate.getHours())+ '</td>' +
						'</tr>' +
					'</table>'+
					'<br>'+
					'<table style="width:100%">'+
						getFoodTable(info, random_letters, row)+
					'</table>'
	;
};
