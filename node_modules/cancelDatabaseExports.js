var exports = module.exports = {};
var conversions = require('conversionExports.js');
var mysql = require('mysql');
var emailer = require('cancelEmailExports.js');


exports.updateDatabase = function(orderID, callbackSix) {
	var connection = mysql.createConnection({
	  	host     : 'SAppD',
	  	user     : 'perdomo',
	  	password : 'password1',
	  	database : 'jury_food'
	});

	connection.connect();	
	var endIndex = 0;
	var numbers = "";
	var letters = "";
	var allClear = false;
	var isDuplicate = false;

	var info = {
		orderId: orderID,
		number: numbers,
		random_alpha: null,
		cancelled: null,
		case_office: null,
		case_year: null,
		case_type: null,
		case_number: null,
		case_judge: null,
		requestor_email: null,
		requestor_telephone: null,
		juror_count: null,
		date_required: null,
		time_required: null,
		meal_type: null,
		meals_requested: null,
		additional_comments: null,
		date_entered: null,
		last_modified: null,
		customFood : []
	};

	var isEmptyObject = function (obj) {
	  for (var key in obj) {
	  	if (Object.prototype.hasOwnProperty.call(obj, key)) {
	      return false;
	    }
	  }
	  return true;
	}

	var isAlphaNumeric = function(input) {
  		return /^\d+[a-zA-Z]+$/.test(input);
	}

	function getAllNums(callbackSeven) {
		for (var i=0; i<orderID.length; i++) {
			if (!isNaN(orderID.charAt(i))) {
				numbers = numbers + orderID.charAt(i);
			} else {
				console.log("NUMBERS: " + numbers);
				endIndex = i;
				break;
			}
		}

		callbackSeven();
	}

	function getAllLetters(callbackEight) {
		console.log("IM IN ONE");
		for (var j=endIndex; j<orderID.length; j++) {
			console.log("IM IN TWO");
			if (orderID.charAt(j).match(/[a-z]/i)) {
				letters = letters + orderID.charAt(j).toUpperCase();
				console.log("LETTERS: " + letters);
			} else {
				console.log("FINAL LETTERS: " + letters);
				break;
			}
		}

		callbackEight();
	}

	function getQueryOne(callbackOne) {
			connection.query('SELECT * FROM jury_food_request WHERE id='+numbers.toString()+' and random_alpha="'+letters.toString()+'"', function(err, rows, fields) {		
				if (isEmptyObject(rows)) {
					console.log('NO SUCH ID ONE');
					allClear = false;
				} else if (rows[0].cancelled === 1) {
					console.log("ALREADY CANCELLED");
					allClear = false;
					isDuplicate = true;
				} else {
					info.number = numbers;
					info.random_alpha = rows[0].random_alpha;
					info.cancelled = rows[0].cancelled;
					info.case_office = rows[0].case_office;
					info.case_year = rows[0].case_year;
					info.case_type = rows[0].case_type;
					info.case_number = rows[0].case_number,
					info.case_judge = rows[0].case_judge,
					info.requestor_email = rows[0].requestor_email,
					info.requestor_telephone = rows[0].requestor_telephone,
					info.juror_count = rows[0].juror_count,
					info.date_required = rows[0].date_required,
					info.time_required = rows[0].time_required,
					info.meal_type = rows[0].meal_type,
					info.meals_requested = rows[0].meals_requested,
					info.additional_comments = rows[0].additional_comments,
					info.date_entered = rows[0].date_entered,
					info.last_modified = rows[0].last_modified
					allClear = true;
					console.log('FINISHED GET QUERY ONE');
				}

				callbackOne();
			});
	};

	function getQueryTwo(callbackTwo) {
		if (allClear && !isDuplicate) {
	  		connection.query('SELECT * FROM jury_food_request_additional_items WHERE request_id="'+numbers.toString()+'"', function(err, rows, fields) {
		 		//if (allClear && !isDuplicate) {
		  		for (var i=0; i<rows.length; i++) {
		  			info.customFood.push({
		  				quantity: rows[i].quantity,
		  				description: rows[i].description
		  			});	

		 		}
		 		console.log('GET EXTRA FOOD DONE');	
		 		console.log("allClear: " + allClear);		
		 		
		 		callbackTwo();			 
	  		});	 
  		} else {
  			callbackTwo();	
  		}
	};

	function updateQueryOne(callbackThree) {
		if (allClear && !isDuplicate) {
			connection.query('UPDATE jury_food_request SET cancelled = "1" WHERE id='+numbers.toString()+' and random_alpha="'+letters.toString()+'"', function(err, result) {		
				if (err) {
					console.log("FAILED ONE");
					allClear = false;
				} else {
					console.log(result); 
					console.log('CANCEL FIELD UPDATED');		
				}

				callbackThree();
			});
		} else {
			callbackThree();
		}
	};

	function updateQueryTwo(callbackFour) {

		if (allClear && !isDuplicate) {
			var currentDate = new Date();
			var year = currentDate.getFullYear();
			var month = conversions.twoDigitMonth(currentDate.getMonth());
			var day = currentDate.getDate();
			var milHours = conversions.convertHour(currentDate.getHours());
			var minutes = conversions.convertMinute(currentDate.getMinutes());
			var seconds = conversions.convertSecond(currentDate.getSeconds());

			var formattedDate = year+'-'+month+'-'+day+' '+milHours+':'+minutes+':'+seconds;

			connection.query('UPDATE jury_food_request SET cancelled_datetime = "'+year+'-'+month+'-'+day+' '+milHours+':'+minutes+':'+seconds+'" WHERE id='+numbers.toString()+' and random_alpha="'+letters.toString()+'"', function(err, result) {		
				if (err) {
					console.log("FAILED TWO");
					allClear = false;
				} else {
					console.log(result); 
					console.log('CANCEL TIME UPDATED');	
				}

				callbackFour();
			});
		} else {
			callbackFour();
		}
	};

	function sendTheEmail(callBackFive) {
		if (allClear && !isDuplicate) {
			emailer.sendEmail(info);
			callBackFive();
		} else {
			callBackFive();
		}
	}

	function printTheMessage(theFunc) {
		console.log("ALL CLEAR: " + allClear);
		theFunc();
	}

	getAllNums(function(err, success) {
		if (err) {
			console.log(err);
		} else {
			getAllLetters(function(err, success) {
				if (err) {
					console.log(err);
				} else {
					getQueryOne(function(err, success) {
						if (err) {
							console.log(err);
						} else {
							getQueryTwo(function(err, success) {
								if (err) {
									console.log(err);
								} else {
									updateQueryOne(function(err, success) {
										if (err) {
											console.log(err);
										} else {
											updateQueryTwo(function(err, success) {
												if (err) {
													console.log(err);
												} else {
													sendTheEmail(function(err, success) {
														if (err) {
															console.log(err);
														} else {
															printTheMessage(function(err, success) {
																if (err) {
																	return callback(false, true);
																	console.log('ERR');
																} else {
																	return callbackSix(allClear, isDuplicate);	
																}
															})																				
														}										
													})
												}
											})
										}
									})
								}
							})
						}
					})
				}
			})
		}
	});
}; //end updateDatabase function
