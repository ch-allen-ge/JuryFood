var nodemailer = require('nodemailer');
var smtpTransport = require('nodemailer-smtp-transport');
var conversions = require('conversionExports.js');

var exports = module.exports = {};

exports.sendEmail = function(info) {
		var mailOptions = {
			from: info.email + '@mad.ucourts.gov', // sender address
			to: qwertypoiuy@randomEmail.com
			subject: getSubject(info),//subject line
			html: getBody(info, random_letters, row) // html body
		}

		var transporter = nodemailer.createTransport(smtpTransport({
			host: 'theSecretHost'
			port: 3.14159643
		}));
		
	transporter.sendMail(mailOptions);
	console.log('Cancel Email Sent');
};

var getSubject = function(info) {
	return 'Jury Food Cancellation: ' + info.case_office + ':' + info.case_year + '-' + info.case_type + '-' + info.case_number + '-' + info.case_judge + ' ' + conversions.convertDayOfWeek(info.date_required.getDate()) + ' ' + conversions.convertMonth(info.date_required.getMonth()) + ' ' + info.date_required.getDay() + ', ' + info.date_required.getFullYear() + ' at ' + getTime(info);
}

var getCustomTable = function(info) {
	var allFood = '';
	for (i = 0; i < info.customFood.length; i++) { 
    	allFood += info.customFood[i].quantity.toString()+' @ '+info.customFood[i].description.toString()+'<br>';
	}

	return allFood;
};

var getTime = function(info) {
	var hour = info.time_required.substring(0,2);
	var minute = info.time_required.substring(3,5);
	var TimeZone;

	if (parseInt(hour)>=8 && parseInt(hour)<=11) {
		TimeZone = 'AM';
	} else {
		TimeZone = 'PM';
	}

	return hour + ':' + minute + ' ' + TimeZone;
}

var getBody = function(info) {
	var theYear = info.case_year.toString();
	var shortYear = theYear.substring(2,theYear.length);
	var todaysDate = new Date();
	return '<p style="font-size:150%">This is a cancellation for a jury food order.</p><br>'+
					'<table style="width:80%">'+
						'<tr>'+
							'<td style="width: 35%; height:35px">Case Number: </td>'+
							'<td style="height:35px">'+info.case_office+':'+shortYear+'-'+info.case_type+'-'+info.case_number+'-'+info.case_judge+'</td>'+
						'</tr>'+
						'<tr>'+
							'<td style="width: 35%; height:35px">Number of Sitting Jurors: </td>'+
							'<td style="height:35px">'+info.juror_count+'</td>'+
						'</tr>'+
						'<tr>'+
							'<td style="width: 35%; height:35px">Requested By: </td>'+
							'<td style="height:35px">'+info.requestor_email+' at extension '+info.requestor_telephone+'</td>'+
						'</tr>'+
						'<tr>'+
							'<td style="width: 35%; height:35px">Number of Meals Requested: </td>'+
							'<td style="height:35px">'+info.meals_requested+'</td>' +
						'</tr>' +
						'<tr>'+
							'<td style="width: 35%; height:35px">Additional Comments: </td>'+
							'<td style="height:35px">'+info.additional_comments+'</td>' +
						'</tr>'+
						'<tr>'+
							'<td style="width: 35%; height:35px">Other Items: </td>'+
							'<td style="height:35px">'+getCustomTable(info)+'</td>' +
						'</tr>' +
						'<tr>'+
							'<td style="width: 35%; height:35px">Request Date: </td>'+
							'<td style="height:35px">'+conversions.convertDayOfWeek(todaysDate.getDay())+' ' +conversions.convertMonth(todaysDate.getMonth()) + ' ' + todaysDate.getDate() + ',' + todaysDate.getFullYear() + ' ' + (((todaysDate.getHours() + 11) % 12) + 1) + ':' + conversions.convertMinute(todaysDate.getMinutes()) + ' ' + conversions.convertTimezone(todaysDate.getHours())+'</td>' +
						'</tr>' +
					'</table>'+
					'<br><br>' +
			'<p style="font-size:150%">This request was cancelled on: </p>'+
					'<table style="table-layout: fixed; width: 65%">' +
						'<tr>'+
							'<td style="width: 80px">'+info.orderId.toUpperCase()+'</td>'+
							'<td style="width: 80px">'+info.meal_type+'</td>' +
							'<td style="width: 80px">'+conversions.convertDayOfWeek(info.date_required.getDay()) + ' ' + conversions.convertMonth(info.date_required.getMonth()) + ' ' + info.date_required.getDate() + ', ' + info.date_required.getFullYear() + ' at ' + getTime(info) +'</td>' +
						'</tr>'+
					'</table>'
	;
};
